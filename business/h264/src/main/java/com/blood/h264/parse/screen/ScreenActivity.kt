package com.blood.h264.parse.screen

import android.content.Intent
import android.hardware.display.DisplayManager
import android.hardware.display.VirtualDisplay
import android.media.MediaCodec
import android.media.MediaCodecInfo
import android.media.MediaFormat
import android.media.projection.MediaProjection
import android.media.projection.MediaProjectionManager
import android.os.Bundle
import android.util.Log
import androidx.appcompat.app.AppCompatActivity
import com.blood.common.Constants.MEDIA_PROJECTION_REQUEST_CODE
import com.blood.common.util.*
import com.blood.h264.databinding.ActivityScreenBinding
import java.io.File
import java.io.IOException

class ScreenActivity : AppCompatActivity() {

    companion object {
        const val TAG = "ScreenActivity"
        const val SAVE_FILE = "screen-codec.h264"
    }

    private lateinit var binding: ActivityScreenBinding
    private lateinit var mediaCodec: MediaCodec
    private lateinit var mediaProjectionManager: MediaProjectionManager
    private lateinit var mediaProjection: MediaProjection
    private lateinit var virtualDisplay: VirtualDisplay
    private var width = 1080
    private var height = 1920
    private var isRunning = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityScreenBinding.inflate(layoutInflater)
        setContentView(binding.root)
        init()
    }

    override fun onDestroy() {
        super.onDestroy()
        isRunning = false
        MediaCodecUtil.releaseMediaCodec(mediaCodec)
        MediaCodecUtil.releaseMediaProjection(mediaProjection)
        MediaCodecUtil.releaseVirtualDisplay(virtualDisplay)
    }

    private fun init() {
        FileUtil.deleteFile(File(filesDir, SAVE_FILE))
        binding.root.post {
            width = binding.root.width
            height = binding.root.height
            if (width % 2 == 1) width--
            if (height % 2 == 1) height--
            Log.i(TAG, "init: $width $height")
            mediaProjectionManager = MediaProjectionUtil.requestMediaProject(this, MEDIA_PROJECTION_REQUEST_CODE)
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        data ?: return
        if (resultCode == RESULT_OK) {
            if (requestCode == MEDIA_PROJECTION_REQUEST_CODE) {
                initMediaCodec()
                initMediaProjection(resultCode, data)
                ThreadPoolUtil.getInstance().start {
                    try {
                        process()
                    } catch (e: Exception) {
                        e.printStackTrace()
                    }
                }
            }
        }
    }

    private fun initMediaCodec() {
        try {
            val mediaFormat = MediaFormat.createVideoFormat(MediaFormat.MIMETYPE_VIDEO_AVC, width, height)
            mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, 15)
            mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, 400000)
            mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, 2)
            // 指定mediaCodec的数据来自于surface
            mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface)
            mediaCodec = MediaCodec.createEncoderByType(MediaFormat.MIMETYPE_VIDEO_AVC)
            mediaCodec.configure(mediaFormat, null, null, MediaCodec.CONFIGURE_FLAG_ENCODE)
        } catch (e: IOException) {
            e.printStackTrace()
        }
    }

    private fun initMediaProjection(resultCode: Int, data: Intent) {
        mediaProjection = mediaProjectionManager.getMediaProjection(resultCode, data)
        virtualDisplay = mediaProjection.createVirtualDisplay( // 将录屏yuv数据存放到指定的surface中
                "screen-codec",
                width,
                height,
                1,
                DisplayManager.VIRTUAL_DISPLAY_FLAG_PUBLIC,
                mediaCodec.createInputSurface(), // 提供一个临时场地，mediaCodec会从该surface中解码数据
                null,
                null
        )
    }

    private fun process() {
        mediaCodec.start()
        isRunning = true
        while (isRunning) {
            // 从mediaCodec获取解码后的数据
            val bufferInfo = MediaCodec.BufferInfo()
            val outputBufferIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, 10000)
            if (outputBufferIndex > -1) {
                val byteArray = MediaCodecUtil.getOutputBufferBytes(mediaCodec, outputBufferIndex, bufferInfo)
                H264Util.writeContent(byteArray, null)
                H264Util.writeBytes(byteArray, File(filesDir, SAVE_FILE))
                // 释放 buffer
                mediaCodec.releaseOutputBuffer(outputBufferIndex, false)
            }
        }
    }

/*
0000000167640032ACB40220087F2CD2905060606D0A13500000000168EE06F2C0
0000000165B840F7FBF4689F0291E29BC50D167AA65EE91F9823B3BAFE1B79AADDB85772717900000300000300000300036C527990BB8F24F3D8B66CE5561CBB488C0EA1CB8EE2000003027A9D21AF294B53827ACA363B0DF3F76C0A24923C394F36314B3C93628B6CC1C548ADEA8D03C06BACE7300A59BDFB187A06EA2B2370E0BE2D92B3E75A9B50B191DF72AC62BF213BB5C6E4483AB649B27678B59E90118D3DF2655EE6426116F56C1AF7CBC81671F7DFAB61A5A9DE37EB0A5DAF6908EF04749591E7F93D4E0902C0E1595A9EB8FDA79E7DE3ECC105E20263FC489A9F1156059A064D11C1EC8B983AC1B943FFEC6C04BD5D2076E992374A9662D76DB4083B218C5F3F06C1E2A8FDD6B36DC40CF7F76195D754676EF68B3E5D3F72887DA3B2178765FFD0C109E5F7FF4E1A75B851AE143DFBB2E7594530001F55315302C96AAB8CD67A996F01E0F985CEDCF6C15AE76878BA396C16399C4B32E9A3595DEC4C84E218FBC8AB14570A9038CECFFFF4EE5B1CDCAA77315AE6C990361CC23138E0A0BDC23F556CFAAAD1CDBE0D884E53FD9761DD013483F9F0125083C9E039C1E458357FF9AE66BB6D0F7AE5650556029AD31C57BE34DDCA2712F741D7EA96DA8FE03A67D619589FD4C07792987ED212B3478AFC978909123C5BA41CBB31C6C0274DD2AF6A0FDEC97726AA9B55D3531D0952100E2350278430F135B672C3397EFFEE9F066090BAC67EC4BE97FADBA7EF428FC7BB3D3969147127C51F0F570DBCF3632EAC5FAFE9785D8210AF6943B28F9752CC7E02827AB2432CBC438E1B52B6446BCB22C43646E8B05AA3D84831CFE92E6CEC05385317F8D55750AF3077A9E6E893B0D55F8A099C16A8F9595C137A71C639107A611B0292E37625DE57C8BCEFB7BF12F481131E369528A54F799628BB5D6FD9C1DA4AB54D87535AB957959ED9D356FB3187F4D9FCA289F17C778704A37A3687FBAF25C6D3E29CCB95EF6A32302736994BA0E0BDD246DBDB61DFB6E551BBAA65FC1285C38ABA676AD283ABCEFAB7DEF0653B02AC0B22FF57ECFCDD72E607A5556E4AFBA7BCD468DD6927A1A36B9C64A6D83FA74CB1149AE28109828B8BFFF5B7BF2F3FF8064F36281D469C0EE17EBD5CE1ADB13D220CCF767D17EA15FA3BB45FFEE72856E6F3F9747EA68F583824D0BE37FB4240F5BF6D6A463D8FF94C2C693CB024BAEE5E6FBF56314F134FF092ADAAAC1C0965F2040E89475592439C1C9729FEA5C7E4028747C1E5DA2225F0C856689B163C9DF1AF9D36399CAD26B70054070C8E3B8099E3DF6A33A47D8389E5601BF022F9DAD899016AE53547D97A09BB535EFA864EF2816622A51080BF8D2DE40A64A66882F8CCD7117B505E2128B23A43DA5D4109C33B808A1557C030F41107C94B5C401086CB02C2FEF91196BB005A996950C4502F24BB84C1A61CA51E9614E4CF1E43EE62EAA51B76A71663A1ECF230BF7E957419D8120483D608DFB886D68163C835C9D529A2B2949F17B9DFA25ACFE6036D0200A4C4BCF441B284FF0531019313F0F5A10C050EF711E13859BB898F2C50F5E82C7D8A53A3247704F4762DB25EF4365DE32C5F958A2FC658D223D292D3CB6DBFEB2C2123CCEE8E859C959A6DFCCFD522706BE76DEAE6E51173B9300D09AB26643347FF4EE5A2F6C0B9A66ACA1897E8359492C035E72BC99A66C0FC4B5434DFAC077B706DA285D8D5A69165C84F018FE756173CDA7843129CE36A6262620DA72CD72C65345BEB0E653AC7C5082776E2048929100F966C9B52C125D2F45C3AC9289A058EA7AF5AFD8426FEB1403EA085D3C7F44A31BEBF2BC602ED06B2112393340E2E94F0C5FF065C9A099490C53B1EDB32B4607FF9D5F89D023D70D340D031AB4743A511ABA89FBF9FDED831AEA235080FD8D94B1CA0BF0691E0C2EF81D4D3ACBC7B494F4A3D0E69AE839F5E4FAFE9697CE5291F84CE0580422D3888A617B0A7A719B334C24B886E389EF37D6ABC6D9931BDCDBB2306103514648DE91F7332C79882C11DBB167C29E15219602A1F90752BB7F95CD9CA14103D26ABC9FDAA87F490F8F92615CFFBA1D5E0C6309AC8B525707CFF9BD8BD296555DDCA4570D962BD864A88AA7EF4E2A802A01AE41CF26BFAA1E7DFDF85FD4149E05FB8EB0729D0E0C93265332DFE5FDE357CBE82315FB46A364ABD408E2DA495D3492EBB601137649749557AC0A1A8EB0A4286090841CEB82540D8ABBECDE8B3F5602478EC3B8D941E8B6C3D1ADE53294BFDC7EC648A3DFD789D80C735DE05542FDD8204CCAAE85A5A309903ED2DEFE196B2B0825DC106516A4125E41A9F417D7ABD7398575F81CADA3C18BAC7798F5ADADC86D6D00780FE5221AD60823BC52BADD1B4295701B85E829B2C6D76D8E3DB83F5C8197BEB542A41930EADF3485C9952D2C3C80202564E9FC2F617D3C1DFCC9E399B4223E303E8D625CE40449F53CD639B14C1A3452E2746007A9029ABB7E0F35DE808DD6D648A8FEFE6A45F9F9161B086D9F3E90ACDA53BFA3E0AA60CE14D10E156699A056A4DCD91821FEA7A0D1C4D3E58FD04CEB0037FC65F045439509C3E7C7213D54F0B206A82DACE816FB390B9A6AC1EFD866556FFAF93EEBA00000300000300000302AF946748599D431BF3FFEA40264DEFDE514BC9E0BA8E237F5B30B27CE1179C9B6BFF36926BE79A96B318A3377479E0B7ADF9F37E2F73F79F815CD4CB7B9F6F5E3B218A7F4DC5299EA1087E38756CC048D56C25C436BEE59B7BD48000029277E38ACC695F1ADEB4B7F83EEF4A911E17E37F475B2FD78839D78428CD328F72D2070C61250EC4489FF45FBA11E9A4DD30C2FC31A2E3D3DE4C67C616CC966607393
0000000141E2208BFFDBD3C0007D2051A9D3EBE1EFE2F66426FE0A64EC83034B69593B602A27E98F35C006F35BAE86088E9E93311F088EB72AE9614523517DD280D3AB961D71DCD9674271E123E9F9672E0017B65C68B8ACB8F8DBB94E9815961C6D49EF28A565A32248BCE6C6EFEEBCD367A0CD4CA3FC55047D13D132FE9F0BFF47DBEC103EE825E4130CD858B96E26B7E3589723A814BBCA542B6970194786D12AF4F81D8906B478C56BCF584A10AE3746827E30C8B263CBB2DFF1A888647CBE5CABFBA1B6DD03A750CCF8892E9EA81842E00F2EBF1BD27E56993CC028A287D92A5C47BDD4EBA719C9379301631A6ECE1C1CF02E3872D532C02285B5211FC38561C12E0220BC54FAD93645305C1657B174E652AE0B3B123B3D69E8E2D4DA70C5F132A1B22C30FD43AB537A35F2A1606DF8034210D14DD129B0EDD8901F2295F29FDD9C00EC8A83BD5B7F90642391BAE0A4F5F7E3D05894DC9BA8B4A5BDA94CCE134ED820739377ED8BE7CC7FFEF8623ECBABDD0F343823366B3F66890EBAB11ADF47C11123D9379C48AFB8B27F0823C00EE26FD2D7073F0067853A90E30666B03296956B49AD9BAD766ECCC1E7F7E292C8233AF7D9FD10CB6D763FA7554474F2E426CE87B2A4B71D79132851454402BC2CF9C72B5E816647DB8401AE9EE89113FAFF5CEDBA562B90F40CC6FD751F149943F3AE10B9F1FF2810A8AA1F871E491DC2D486BC3191041E2522FA26B377476B00587AB15E4E290F40FB13C63DE28022D44E00F5D16CC177DDBC0CD7DEB1D514807FA7EC25CC5BC43B76036B651F0937A29D84A7952E9BFFA5B2CDC39CC7F52D22D7776BF23246BABE57414DEAB44FAB6A481EFD8FB537FFB93AA3A69C68B70A5754956546CE66E498E91A187752F43E3F26F79E2A3283AB5366A1A8FDF0BD536B139C791E05A3A6E6DC18E577D4E5081AD84DEF9A55852D9A93A586A425C34D3BE7FD73F9957951A76B30DEA909F0DD601A4B5CFEEA929621D18DEDAA429C38DC275937BFEAA625D57793AF6A90B30E9719FB4DF00CA9E9885E4EB7795E553A43BC3126F8005514C9CF3B675CAF2C9D32008D5CE40DF11D446C50253CAF2C9D41A62D5CE40CF12D471C6E2DFCAF2E9D49CE30B6E80A5564D779013D395E5F3AA3D069D9C823E27A94780C75395E673AA40150ADD024AAC9B37038EF1A90F30FD98E436BA04155936A6111F33522061FB37C9ED740A2AB26D1C3C4086A444C3F68B8275D030AAC9B67129081A911F55461E15D740E2AB26D284E4326A449D551B785ADD034AAC9B62141091A912B5546FE1E3740F2AB26D78544286A449D551BF888DD044AAC9B761510B1A912F5546FE22374112AB26E685442C6A44DD551BF888DD044AAC9BAE1510B1A91375546FE22374112AB26F085442C6A44DD551BF888DD044AAC9BDE1510B1A91375546FE22374112AB26FC85442C6A44DD551BF888DD044AAC9C021510B1A91375546FE22374112AB270585442C6A44DD551BF888DD044AAC9C261510B1A91375546FE22374112AB270D85442C6A44DD551BF888DD044AAC9C461510B1A91375546FE22374112AB270DE279A5AA44DD551BF888DD044AAC9C3F89E696A91375546FE22374112AB2713E279A5AA44DD551BF888DD044AAC9C5F89E696A91375546FE22374112AB2718E279A5AA44DD551BF888DD044AAC9C7389E696A91375546FE22374112AB271DE279A5AA44DD551BF888DD044AAC9C8789E696A91375546FE22374112AB2722E279A5AA44DD551BF888DD044AAC9C9789E696A91375546FE22374112AB2726E279A5AA44DD551BF888DD044AAC9CA789E696A91375546FE22374112AB272AE279A5AA44DD551BF888DD044AAC9CB789E696A91375546FE22374112AB272EE279A5AA44DD551BF888DD044AAC9CBF89E696A91375546FE22374112AB2732E279A5AA44DD551BF888DD044AAC9CCF89E696A91375546FE22374112AB2734E279A5AA44DD551BF888DD044AAC9CD389E696A913755D800000000000000
0000000141E4208BFFDBD3C0007D2051A78F8B0D1735F9A0CBB22F256379607E4D14AE8CAA21474C336D12B87EBBC9592C3DC6154F436006456E5D3AA9837D47295CD1B4165C8355C5241D611697C1B01C12A9B59BBB28322BFCBAB4699F92D9149BA63241C907F91D80DF76FAAD05CBB9951499E65C1485CC466BFFE1D323F41D903D4A1224F571D9E3FE7FED6834C4DAE960F65A328C7E2378958DE818DA9E1006B69E9BE0E61BCA75394E6565DF4732768509C7E8D83C024123A494B43453D926B844DF07BF3F2C809384D155A6C5BAEAF24A3D062FC5856A45301091BAB35A5BE40D6EB6D615286AF665C1974237088EB8A30DC8C39F01A31B0B5A48ABD66CE78F9BBC83E37BF59EF53AC96D69ED69607229684E06603D3204410A8C3CAF11B2FB04C51F5892BD0B57798683D36A09A701DE983FD7AF43573A8A8920A234B2D8C8F61BE0F10C2546AA0012797FA743C98AFA77F2A801CE5ED948604A722C64EA923AE6A5493C39651E50DC9530447DAFA34D6C3341058B0BAEF516CD4F3CE9732C2EF0F134E4E2AB1484808A8AE0D8B1F50BAD19A00A8CAD8EC9031CAA4DA32F300DA0F76DA24AA4AD374DD55DDDCD44CFC2F85357F34954D63DB12F53AF4CEC84FADD5E12C25F6CDF1167FD3B046207C6FB543F079897C2F8EB6FC8ECF81377D15159CBE6CA2D259E9FE2B6CF80DBC725178B656C508DEA949FFDB9B841C5C2BA63DDBCBA3A8ABA4D750C625E280AE45E3012E45E3512E65E4612E65E4622E75E5322E7DE4E0C67DE571067DE5F10675E5F20675E622068DE4A12E8DE5022E8DE5022E9DE5322E9DE4E2069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE542069DE54225000000000000000000000
*/

}